<!DOCTYPE html>
<html lang="en">
{{template "head.gohtml" .}}
<body>
<div id="methone-container-replace"></div>
<div class="page-title">
    <h1>Resultatrapport</h1>
</div>
<div class="centering">
<h2>Vad har spenderats på min budgetpost?</h2>
</div>

<br>
<div class="centering">
    <p>Nedan kan du se vad som har spenderats på en viss budgetpost.</p>
    <p>Du kan sortera på både år och resultatställe.</p>
    <p>Väljer du ett år så ser du endast de resultatställen som hade kostnader det året.</p>
    <p class="hide-on-tiny-mobile">Väljer du det nuvarande året kan du även se vad som är budgetterat för posterna</p>
</div>
<br>
<div class="centering">
    <p><strong>OBS!</strong></p>
    <p><strong>Räknar endast med kvitton och fakturor i Cashflow</strong></p>
    <p><strong>Den räknar inte med sektionskort, autogiro eller icke uppladdade fakturor</strong></p>
    <p><strong>Budgetposter som byter namn eller flyttas kan inte matchas korrekt</strong></p>
    <p><strong>Därför kan GOrdian inte antas ha fullständig korrekthet</strong></p>
    <p><strong>Det är ditt ansvar att se till du tar hänsyn till detta när du använder informationen</strong></p>
</div>
<br>
<form class="centering" id="reportForm">
    <div class="form-field">
        <label for="yearSelect" class="form-label">År:</label>
        <select name="year" id="yearSelect" class="form-select">
            <option {{if or (eq $.SelectedYear "Alla") (eq $.SelectedYear "")}}selected{{end}}>Alla</option>
            {{range $_, $year := .years}}
                <option {{if eq $year $.SelectedYear}}selected{{end}}>{{$year}}</option>
            {{end}}
        </select>
    </div>
    
    <div class="form-field">
        <label for="costCentreSelect" class="form-label">Resultatställe:</label>
        <select name="cc" id="costCentreSelect" class="form-select">
            <option {{if or (eq $.SelectedCC "Alla") (eq $.SelectedCC "")}}selected{{end}}>Alla</option>
            {{range $_, $CC := .CCList}}
                <option {{if eq $CC $.SelectedCC}}selected{{end}}>{{$CC}}</option>
            {{end}}
        </select>
    </div>
    
    <div class="form-field" id="unspentCheckboxContainer" {{if not (eq $.CurrentYear $.SelectedYear)}}style="display: none;"{{end}}>
        <label for="showUnspentCheck" class="form-label">
            <input type="checkbox" name="showUnspent" id="showUnspentCheck" value="true">
            Visa ospenderade budgetposter
        </label>
    </div>
    
    <div class="form-field" id="overspentCheckboxContainer" {{if not (eq $.CurrentYear $.SelectedYear)}}style="display: none;"{{end}}>
        <label for="showOverspentCheck" class="form-label">
            <input type="checkbox" name="showOverspent" id="showOverspentCheck" value="true">
            Visa endast sprängda budgetposter
        </label>
    </div>
    
    <button class="form-button">
        Visa
    </button>
</form>


<div id="costCentre">
    <div id="content">  
        <table style="table-layout: fixed; width: 100%;">
            <tr style="background-color: rgb(176,190,197) !important;">
                <th>Resultatställe</th>
                <th>Spenderat</th>
                {{if eq $.CurrentYear $.SelectedYear}}
                    <th class="hide-on-tiny-mobile">Budgeterat</th>
                    <th class="hide-on-tiny-mobile">Rest</th>
                {{end}}
            </tr>
            <tr style="height: 1em;"></tr>
            {{range $_, $ReportCostCentreLine := .report }}
                {{$costCentreHasOverspent := false}}
                {{range $_, $secCC := $ReportCostCentreLine.SecondaryCostCentresList}}
                    {{range $_, $bl := $secCC.BudgetLinesList}}
                        {{if $bl.IsOverspent}}
                            {{$costCentreHasOverspent = true}}
                        {{end}}
                    {{end}}
                {{end}}
                <tr class="cost-centre-header {{if not $costCentreHasOverspent}}not-overspent-costcentre{{end}}" style="background-color: rgb(176,190,197) !important;">
                    <th>{{$ReportCostCentreLine.CostCentreName}}</th>
                    <th>
                        {{$ReportCostCentreLine.Total}} kr
                    </th>
                    {{if eq $.CurrentYear $.SelectedYear}}
                        <th class="hide-on-tiny-mobile">
                             {{if $ReportCostCentreLine.Budget}}
                                 {{$ReportCostCentreLine.Budget}} kr
                             {{else}}
                                 -
                             {{end}}
                        </th>
                        <th class="hide-on-tiny-mobile {{if $ReportCostCentreLine.IsOverspent}}negative{{end}}">
                             {{if $ReportCostCentreLine.Budget}}
                                 {{$ReportCostCentreLine.Remaining}} kr
                             {{else}}
                                 -
                             {{end}}
                        </th>
                    {{end}}
                </tr>
                {{range $_, $ReportSecondaryCostCentreLine := $ReportCostCentreLine.SecondaryCostCentresList}}
                    {{$hasSpentLines := false}}
                    {{$hasOverspentLines := false}}
                    {{range $_, $bl := $ReportSecondaryCostCentreLine.BudgetLinesList}}
                        {{if ne $bl.Total "0"}}
                            {{$hasSpentLines = true}}
                        {{end}}
                        {{if $bl.IsOverspent}}
                            {{$hasOverspentLines = true}}
                        {{end}}
                    {{end}}
                    <tr class="secondary-cost-centre-header {{if not $hasSpentLines}}unspent-section{{end}} {{if not $hasOverspentLines}}not-overspent-secondary{{end}}" style="background-color: rgb(207,216,220) !important;{{if not $hasSpentLines}} display: none;{{end}}">
                        <th>  
                            {{$ReportSecondaryCostCentreLine.SecondaryCostCentreName}}
                        </th>
                        <th> 
                            {{$ReportSecondaryCostCentreLine.Total}} kr          
                        </th>
                        {{if eq $.CurrentYear $.SelectedYear}}
                            <th class="hide-on-tiny-mobile">
                                {{if $ReportSecondaryCostCentreLine.Budget}}
                                    {{$ReportSecondaryCostCentreLine.Budget}} kr
                                {{else}}
                                    -
                                {{end}}
                            </th>
                            <th class="hide-on-tiny-mobile {{if $ReportSecondaryCostCentreLine.IsOverspent}}negative{{end}}">
                                {{if $ReportSecondaryCostCentreLine.Budget}}
                                    {{$ReportSecondaryCostCentreLine.Remaining}} kr
                                {{else}}
                                    -
                                {{end}}
                            </th>
                        {{end}}
                    </tr>
                    {{range $_, $ReportBudgetLine := $ReportSecondaryCostCentreLine.BudgetLinesList}}
                        <tr class="budget-line {{if and (eq $.CurrentYear $.SelectedYear) (or (eq $ReportBudgetLine.Total "0") (eq $ReportBudgetLine.Total "0,0") (eq $ReportBudgetLine.Total "0,00"))}}unspent-line{{end}} {{if not $hasSpentLines}}unspent-section{{end}} {{if not $ReportBudgetLine.IsOverspent}}not-overspent-line{{end}} {{if not $hasOverspentLines}}not-overspent-secondary{{end}}" {{if and (eq $.CurrentYear $.SelectedYear) (or (eq $ReportBudgetLine.Total "0") (eq $ReportBudgetLine.Total "0,0") (eq $ReportBudgetLine.Total "0,00"))}}style="display: none;"{{end}}>
                            <td class="net">  
                                {{$ReportBudgetLine.BudgetLineName}}
                            </td>
                            <td class="net">  
                                {{$ReportBudgetLine.Total}} kr
                            </td>
                            {{if eq $.CurrentYear $.SelectedYear}}
                                <td class="net hide-on-tiny-mobile">
                                    {{if $ReportBudgetLine.Budget}}
                                        {{$ReportBudgetLine.Budget}} kr
                                    {{else}}
                                        -
                                    {{end}}
                                </td>
                                <td class="hide-on-tiny-mobile {{if $ReportBudgetLine.IsOverspent}}negative{{else}}net{{end}}">
                                    {{if $ReportBudgetLine.Budget}}
                                        {{$ReportBudgetLine.Remaining}} kr
                                    {{else}}
                                        -
                                    {{end}}
                                </td>
                            {{end}}
                        </tr>
                    {{end}}
                    <tr class="spacer-row {{if not $hasSpentLines}}unspent-section{{end}} {{if not $hasOverspentLines}}not-overspent-secondary{{end}}" style="height: 1em;{{if not $hasSpentLines}} display: none;{{end}}"></tr>
                {{end}}
                <tr class="cost-centre-spacer {{if not $costCentreHasOverspent}}not-overspent-costcentre{{end}}" style="height: 3em;"></tr>
            {{end}}
        </table>
    </div>
</div>
<footer class="footer-toolbar">
    <p>{{ .motd }} © 2024 GOrdian</p>
    Budgetsystemet är skrivet av <a href="https://github.com/DouglasFischer">Douglas Fischer</a>
</footer>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const yearSelect = document.getElementById('yearSelect');
    const costCentreSelect = document.getElementById('costCentreSelect');
    const showUnspentCheck = document.getElementById('showUnspentCheck');
    const reportForm = document.getElementById('reportForm');
    const currentYear = '{{$.CurrentYear}}';
    
    // Show/hide checkbox based on year selection - removed, now always visible
    yearSelect.addEventListener('change', function() {
        const selectedYear = this.value;
        
        // Fetch cost centres for the selected year
        fetch('/api/CostCentresByYear?year=' + encodeURIComponent(selectedYear))
            .then(response => response.json())
            .then(costCentres => {
                // Clear existing options
                costCentreSelect.innerHTML = '';
                
                // Add "Alla" option
                const allaOption = document.createElement('option');
                allaOption.value = 'Alla';
                allaOption.textContent = 'Alla';
                costCentreSelect.appendChild(allaOption);
                
                // Add cost centre options
                costCentres.forEach(cc => {
                    const option = document.createElement('option');
                    option.value = cc;
                    option.textContent = cc;
                    costCentreSelect.appendChild(option);
                });
                
                // Try to maintain the current selection if it still exists
                const currentCostCentre = '{{$.SelectedCC}}';
                const options = Array.from(costCentreSelect.options);
                const matchingOption = options.find(option => option.value === currentCostCentre);
                if (matchingOption) {
                    costCentreSelect.value = currentCostCentre;
                } else {
                    // Default to "Alla" if current selection is no longer available
                    costCentreSelect.value = 'Alla';
                }
            })
            .catch(error => {
                console.error('Error fetching cost centres:', error);
                // On error, reset to "Alla"
                costCentreSelect.innerHTML = '<option value="Alla">Alla</option>';
                costCentreSelect.value = 'Alla';
            });
    });
    
    // Toggle unspent budget lines visibility without reloading the page
    showUnspentCheck.addEventListener('change', function() {
        // Make mutually exclusive with overspent checkbox
        const showOverspentCheck = document.getElementById('showOverspentCheck');
        if (this.checked && showOverspentCheck.checked) {
            showOverspentCheck.checked = false;
            // Trigger overspent checkbox change to reset visibility
            showOverspentCheck.dispatchEvent(new Event('change'));
        }
        
        const unspentLines = document.querySelectorAll('.unspent-line');
        const unspentSections = document.querySelectorAll('.unspent-section');
        
        if (this.checked) {
            unspentLines.forEach(line => {
                line.style.display = '';
            });
            unspentSections.forEach(section => {
                section.style.display = '';
            });
        } else {
            unspentLines.forEach(line => {
                line.style.display = 'none';
            });
            unspentSections.forEach(section => {
                section.style.display = 'none';
            });
        }
    });
    
    // Toggle to show only overspent budget lines
    const showOverspentCheck = document.getElementById('showOverspentCheck');
    showOverspentCheck.addEventListener('change', function() {
        // Make mutually exclusive with unspent checkbox
        if (this.checked && showUnspentCheck.checked) {
            showUnspentCheck.checked = false;
            // Trigger unspent checkbox change to reset visibility
            showUnspentCheck.dispatchEvent(new Event('change'));
        }
        
        const notOverspentLines = document.querySelectorAll('.not-overspent-line');
        const notOverspentSecondaries = document.querySelectorAll('.not-overspent-secondary');
        const notOverspentCostCentres = document.querySelectorAll('.not-overspent-costcentre');
        
        if (this.checked) {
            notOverspentLines.forEach(line => {
                line.style.display = 'none';
            });
            notOverspentSecondaries.forEach(secondary => {
                secondary.style.display = 'none';
            });
            notOverspentCostCentres.forEach(costCentre => {
                costCentre.style.display = 'none';
            });
        } else {
            notOverspentLines.forEach(line => {
                line.style.display = '';
            });
            notOverspentSecondaries.forEach(secondary => {
                secondary.style.display = '';
            });
            notOverspentCostCentres.forEach(costCentre => {
                costCentre.style.display = '';
            });
        }
    });
});
</script>
</body>
</html>