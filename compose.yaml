services:
  app:
    build:
      context: .
      target: code
    init: true
    ports: [3000:3000]
    environment:
      - "GO_CONN=host=gordian-db port=5432 user=alexander password=kopis dbname=budget sslmode=disable"
      - "CF_CONN=host=cashflow-db port=5432 user=cashflow password=cashflow dbname=cashflow sslmode=disable"
      - LOGIN_API_URL=http://nyckeln:7002
      - LOGIN_FRONTEND_URL=http://localhost:7002
      - HIVE_URL=http://nyckeln:7004/api/v1
      - HIVE_TOKEN=shmunguss
      - SERVER_PORT=3000
      - SERVER_URL=http://localhost:3000
      - LOGIN_TOKEN=shmunguss
    depends_on:
      gordian-db:
        condition: service_healthy
      cashflow-db:
        condition: service_healthy
    develop:
      watch:
        - path: .
          action: sync+restart
          target: /src/
        - path: go.sum
          action: rebuild
    command: go run .
  gordian-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=budget
      - POSTGRES_USER=alexander
      - POSTGRES_PASSWORD=kopis
    healthcheck:
      test:
        - "CMD-SHELL"
        - "sh -c 'pg_isready -d budget -U alexander'"
      interval: 1s
      timeout: 5s
      retries: 5
      start_period: 10s
  cashflow-db:
    image: postgres:16-alpine
    environment:
      - POSTGRES_DB=cashflow
      - POSTGRES_USER=cashflow
      - POSTGRES_PASSWORD=cashflow
    healthcheck:
      test:
        - "CMD-SHELL"
        - "sh -c 'pg_isready -d cashflow -U cashflow'"
      interval: 1s
      timeout: 5s
      retries: 5
      start_period: 10s
  nyckeln:
    image: ghcr.io/datasektionen/nyckeln-under-dorrmattan
    environment:
      KTH_ID: lukmal #change to change user
    configs:
      - source: nyckeln.yaml
        target: /config.yaml
    ports:
      - 7001:7001
      - 7002:7002
      - 7003:7003
      - 7004:7004

configs:
  nyckeln.yaml:
    content: |
      # Used when migrated to sso
      # clients:
      #   - id: "client-id"
      #     secret: "client-secret"
      #     redirect_uris:
      #       - http://localhost:4000/oidcc/callback
      #
      # users:
      #   - ug_kth_id: some-id
      #     kth_id: turetek
      #     email: turetek@kth.se
      #     first_name: Ture
      #     family_name: Teknolog
      #     year_tag: D-83
      #   - ug_kth_id: some-other-id
      #     kth_id: diadat
      #     email: diadat@kth.se
      #     first_name: Diana
      #     family_name: Datalog
      #     year_tag: D-83
      #   - ug_kth_id: yet-anouther-id
      #     kth_id: marmed
      #     email: marmed@kth.se
      #     first_name: Martin
      #     family_name: Median
      #     year_tag: M-00

      users:
      - kth_id: lukmal
      - kth_id: viktoe

      hive:
        groups:
          - name: Kass√∂r
            id: kassor
            domain: example.com
            members:
              - lukmal
            permissions:
              - id: admin
          - name: Systemansvarig
            id: d-sys
            domain: example.com
            members:
              - viktoe
            permissions:
              - id: view-all
